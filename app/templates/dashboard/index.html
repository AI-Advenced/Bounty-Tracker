{% extends "base.html" %}

{% block title %}Dashboard - Advanced Bounty Tracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header with stats -->
    <div class="mb-8">
        <div class="md:flex md:items-center md:justify-between">
            <div class="flex-1 min-w-0">
                <h1 class="text-3xl font-bold leading-7 text-gray-900 sm:text-4xl sm:truncate">
                    <i class="fas fa-chart-line mr-3 text-primary-600"></i>
                    Dashboard des Bounties
                </h1>
                <p class="mt-2 text-lg text-gray-600">
                    Découvrez les dernières opportunités de bounties GitHub
                </p>
            </div>
            <div class="mt-4 flex md:mt-0 md:ml-4">
                <button onclick="refreshData()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2">
                    <i class="fas fa-sync-alt"></i>
                    <span>Actualiser</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Bounties -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
            <div class="p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-coins text-primary-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Bounties</dt>
                        <dd class="text-2xl font-bold text-gray-900">{{ "{:,}".format(stats.total_bounties) }}</dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Value -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
            <div class="p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-success-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <dt class="text-sm font-medium text-gray-500 truncate">Valeur Totale</dt>
                        <dd class="text-2xl font-bold text-gray-900">${{ "{:,.2f}".format(stats.total_value) }}</dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Bounties -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
            <div class="p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-warning-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <dt class="text-sm font-medium text-gray-500 truncate">Bounties Actifs</dt>
                        <dd class="text-2xl font-bold text-gray-900">{{ "{:,}".format(stats.active_bounties) }}</dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- Repositories -->
        <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
            <div class="p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-code-branch text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <dt class="text-sm font-medium text-gray-500 truncate">Repositories</dt>
                        <dd class="text-2xl font-bold text-gray-900">{{ "{:,}".format(stats.total_repositories) }}</dd>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Bounty Value Chart -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Évolution des Bounties</h3>
                <div class="flex space-x-2">
                    <button onclick="updateChartPeriod('7d')" class="chart-period-btn active px-3 py-1 text-sm bg-primary-100 text-primary-700 rounded-md" data-period="7d">7j</button>
                    <button onclick="updateChartPeriod('30d')" class="chart-period-btn px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-md" data-period="30d">30j</button>
                    <button onclick="updateChartPeriod('90d')" class="chart-period-btn px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-md" data-period="90d">90j</button>
                </div>
            </div>
            <div class="h-64">
                <canvas id="bountyChart"></canvas>
            </div>
        </div>

        <!-- Language Distribution -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Langages Populaires</h3>
            <div class="h-64">
                <canvas id="languageChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions Rapides</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="/search?q=bounty&min_amount=100" class="block p-4 border border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-md transition-all">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-search text-primary-600 text-xl"></i>
                    <div>
                        <h4 class="font-medium text-gray-900">Bounties High-Value</h4>
                        <p class="text-sm text-gray-500">Bounties de plus de $100</p>
                    </div>
                </div>
            </a>
            
            <a href="/issues?language=javascript&has_bounty=true" class="block p-4 border border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-md transition-all">
                <div class="flex items-center space-x-3">
                    <i class="fab fa-js-square text-warning-600 text-xl"></i>
                    <div>
                        <h4 class="font-medium text-gray-900">JavaScript Issues</h4>
                        <p class="text-sm text-gray-500">Issues JavaScript avec bounties</p>
                    </div>
                </div>
            </a>
            
            <a href="/repositories?sort=bounties&language=python" class="block p-4 border border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-md transition-all">
                <div class="flex items-center space-x-3">
                    <i class="fab fa-python text-success-600 text-xl"></i>
                    <div>
                        <h4 class="font-medium text-gray-900">Projets Python</h4>
                        <p class="text-sm text-gray-500">Repos Python avec bounties</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Recent Bounties -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Derniers Bounties</h3>
                <a href="/issues" class="text-primary-600 hover:text-primary-700 text-sm font-medium">Voir tous</a>
            </div>
        </div>
        
        <div class="overflow-hidden">
            {% if issues %}
            <div class="divide-y divide-gray-200">
                {% for issue in issues %}
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-3 mb-2">
                                <!-- Bounty Amount Badge -->
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-success-100 text-success-800">
                                    <i class="fas fa-dollar-sign mr-1"></i>
                                    {{ issue.bounty_formatted }}
                                </span>
                                
                                <!-- Status Badge -->
                                {% if issue.status.value == 'open' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-success-100 text-success-800">
                                    <i class="fas fa-circle mr-1 text-xs"></i>
                                    Ouvert
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-check-circle mr-1 text-xs"></i>
                                    Fermé
                                </span>
                                {% endif %}
                                
                                <!-- Language Badge -->
                                {% if issue.primary_language %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ issue.primary_language }}
                                </span>
                                {% endif %}
                            </div>
                            
                            <h4 class="text-lg font-medium text-gray-900 mb-2 hover:text-primary-600">
                                <a href="/issues/{{ issue.id }}">{{ issue.title }}</a>
                            </h4>
                            
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="flex items-center">
                                    <i class="fas fa-code-branch mr-2"></i>
                                    <a href="https://github.com/{{ issue.repository_full_name }}" 
                                       target="_blank" 
                                       class="hover:text-primary-600">
                                        {{ issue.repository_full_name }}
                                    </a>
                                </span>
                                
                                <span class="flex items-center">
                                    <i class="fas fa-user mr-2"></i>
                                    {{ issue.author_username }}
                                </span>
                                
                                <span class="flex items-center">
                                    <i class="fas fa-clock mr-2"></i>
                                    <span class="relative-time" data-date="{{ issue.github_created_at.isoformat() }}">
                                        {{ issue.github_created_at.strftime('%d/%m/%Y') }}
                                    </span>
                                </span>
                                
                                {% if issue.comments_count > 0 %}
                                <span class="flex items-center">
                                    <i class="fas fa-comments mr-2"></i>
                                    {{ issue.comments_count }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 ml-4">
                            <a href="{{ issue.html_url }}" 
                               target="_blank"
                               class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
                                <i class="fab fa-github text-lg"></i>
                            </a>
                            
                            <a href="/issues/{{ issue.id }}" 
                               class="p-2 text-gray-400 hover:text-primary-600 rounded-full hover:bg-gray-100">
                                <i class="fas fa-eye text-lg"></i>
                            </a>
                        </div>
                    </div>
                    
                    {% if issue.body and issue.body|length > 100 %}
                    <div class="mt-3">
                        <p class="text-gray-700 text-sm line-clamp-2">
                            {{ issue.body[:200] }}{% if issue.body|length > 200 %}...{% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-12 text-center">
                <i class="fas fa-coins text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun bounty trouvé</h3>
                <p class="text-gray-500">Les nouveaux bounties apparaîtront ici une fois découverts.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize charts
    let bountyChart = null;
    let languageChart = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        updateRelativeTimes();
        
        // Update relative times every minute
        setInterval(updateRelativeTimes, 60000);
    });
    
    function initializeCharts() {
        // Bounty Evolution Chart
        const bountyCtx = document.getElementById('bountyChart').getContext('2d');
        
        // Sample data - replace with real API call
        const bountyData = {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [{
                label: 'Nouvelles Issues',
                data: [12, 19, 8, 15, 22, 18, 25],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Valeur Bounties ($)',
                data: [1200, 2100, 800, 1800, 3200, 2200, 2800],
                borderColor: 'rgb(34, 197, 94)', 
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y1'
            }]
        };
        
        bountyChart = new Chart(bountyCtx, {
            type: 'line',
            data: bountyData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
        
        // Language Distribution Chart  
        const languageCtx = document.getElementById('languageChart').getContext('2d');
        
        const languageData = {
            labels: ['JavaScript', 'Python', 'Java', 'TypeScript', 'Go', 'Rust'],
            datasets: [{
                data: [30, 25, 20, 15, 7, 3],
                backgroundColor: [
                    '#F7DF1E', // JavaScript
                    '#3776AB', // Python
                    '#ED8B00', // Java
                    '#3178C6', // TypeScript
                    '#00ADD8', // Go
                    '#CE422B'  // Rust
                ],
                borderWidth: 0
            }]
        };
        
        languageChart = new Chart(languageCtx, {
            type: 'doughnut',
            data: languageData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }
    
    function updateChartPeriod(period) {
        // Update active button
        document.querySelectorAll('.chart-period-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-primary-100', 'text-primary-700');
            btn.classList.add('bg-gray-100', 'text-gray-600');
        });
        
        const activeBtn = document.querySelector(`[data-period="${period}"]`);
        activeBtn.classList.add('active', 'bg-primary-100', 'text-primary-700');
        activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
        
        // Update chart data based on period
        // This would normally make an API call to get new data
        console.log('Updating chart for period:', period);
    }
    
    function updateRelativeTimes() {
        document.querySelectorAll('.relative-time').forEach(el => {
            const date = el.getAttribute('data-date');
            if (date) {
                el.textContent = dayjs(date).fromNow();
            }
        });
    }
    
    function refreshData() {
        // Show loading state
        const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
        const originalHtml = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Actualisation...</span>';
        
        // Simulate API call
        setTimeout(() => {
            // Reload the page or update data via API
            window.location.reload();
        }, 1000);
    }
</script>
{% endblock %}